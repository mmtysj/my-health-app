<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ RosieTrack - Blossom into Your Best Self</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Poppins for a softer feel) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>

    <style>
        /* --- General & App Container --- */
        body {
            font-family: 'Poppins', 'Mitr', sans-serif;
            background-color: #fce4ec; /* A slightly deeper pink background */
        }
        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }

        /* --- Login Page & Card --- */
        .login-page {
             background: linear-gradient(135deg, #ffd1dc 0%, #ffb6c1 100%);
        }
        .login-card {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(255, 182, 193, 0.3);
            padding: 2rem;
        }

        /* --- Buttons --- */
        .btn-primary {
            background-color: #ff8fab;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            border: none;
        }
        .btn-primary:hover {
            background-color: #ff6b8b;
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: #fecdd3;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #f3f4f6;
            color: #4b5563;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        /* --- Form & Inputs --- */
        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #fecdd3;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #ff8fab;
            box-shadow: 0 0 0 3px rgba(255, 143, 171, 0.2);
            outline: none;
        }
        
        /* --- Tabs --- */
        .auth-tab.tab-active {
            color: #ff8fab;
            border-bottom: 3px solid #ff8fab;
            font-weight: 600;
        }
        .auth-tab.tab-inactive {
            color: #a0aec0;
            border-bottom: 3px solid transparent;
        }
        .nav-item.tab-active {
            color: #ff8fab;
        }
        .nav-item.tab-inactive {
            color: #a0aec0;
        }

        /* --- Main App Cards & Components --- */
        .card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            padding: 1.25rem;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 182, 193, 0.2);
        }
        .progress-bar {
            height: 10px;
            background-color: #edf2f7;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #ff8fab;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        .water-drop {
            width: 30px;
            height: 30px;
            background-color: #a7d7f9;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            margin: 0 5px;
            opacity: 0.5;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .water-drop.filled {
            background-color: #0ea5e9;
            opacity: 1;
        }
        
        /* --- Calendar --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .calendar-day {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            background-color: #fecdd3;
        }
        .calendar-day.period {
            background-color: #ff8fab;
            color: white;
        }
        .calendar-day.predicted {
            background-color: #fecdd3;
            color: #ff6b8b;
        }
        .calendar-day.today {
            border: 2px solid #ff8fab;
            font-weight: bold;
        }

        /* --- Animation & Modals --- */
        .tab-content {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-container">
        <!-- Auth Screen -->
        <div id="auth-screen" class="login-page flex-grow flex flex-col justify-center items-center p-4">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">üå∏ RosieTrack</h1>
                <p class="text-white/80 mt-2">Blossom into Your Best Self</p>
            </div>
            
            <div class="login-card w-full max-w-sm">
                <div class="flex mb-6">
                    <button id="login-tab" class="auth-tab w-1/2 py-2 text-center font-medium tab-active">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="register-tab" class="auth-tab w-1/2 py-2 text-center font-medium tab-inactive">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </div>

                <div id="auth-error" class="w-full text-red-500 mb-4 text-sm h-5 text-center font-semibold"></div>
                
                <!-- Login Form -->
                <div id="login-form" class="block">
                    <div class="mb-4">
                        <label class="block text-gray-600 mb-2 text-sm">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" id="login-email" class="input-field" placeholder="your@email.com">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-600 mb-2 text-sm">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="login-password" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button id="login-btn" class="btn-primary">
                         <span class="btn-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                         <span class="btn-loader hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                    </button>
                </div>
                
                <!-- Register Form -->
                <div id="register-form" class="hidden">
                    <div class="mb-4">
                        <label class="block text-gray-600 mb-2 text-sm">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="register-name" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-600 mb-2 text-sm">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" id="register-email" class="input-field" placeholder="your@email.com">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-600 mb-2 text-sm">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="register-password" class="input-field" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">
                    </div>
                    <button id="register-btn" class="btn-primary">
                        <span class="btn-text">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
                        <span class="btn-loader hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main App Content -->
        <div id="main-app" class="hidden flex-grow flex flex-col">
            <header class="p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">üå∏ RosieTrack</h1>
                <div id="profile-avatar" class="w-10 h-10 bg-pink-200 rounded-full flex items-center justify-center font-bold text-pink-600"></div>
            </header>

            <main class="flex-grow p-4 space-y-6 overflow-y-auto">
                 <!-- Weight Tracker Tab -->
                <div id="weight-tracker-tab" class="tab-content">
                    <div class="card">
                        <h2 class="text-lg font-bold text-gray-700 mb-4">‚öñÔ∏è Weight Tracker</h2>
                        <div class="grid grid-cols-3 gap-4 text-center mb-4">
                            <div>
                                <p class="text-sm text-gray-500">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                                <p id="current-weight-display" class="text-xl font-bold text-pink-500">-- kg</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p>
                                <p id="goal-weight-display" class="text-xl font-bold text-gray-700">-- kg</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å</p>
                                <p id="weight-diff-display" class="text-xl font-bold text-green-500">-- kg</p>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm font-medium mb-1">
                                <span class="text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                                <span id="progress-percent-display" class="text-pink-600">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="progress-fill-bar" class="progress-fill" style="width: 0%;"></div>
                            </div>
                        </div>
                        <button id="open-weight-modal-btn" class="w-full btn-primary py-2">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</button>
                    </div>
                    <div class="card mt-6">
                        <h3 class="font-bold text-gray-700 mb-2">‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <div class="relative h-64">
                            <canvas id="weight-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Meal Planner Tab -->
                <div id="meal-planner-tab" class="tab-content hidden">
                     <div class="card">
                        <h2 class="text-lg font-bold text-gray-700 mb-2">üçΩÔ∏è Meal Planner</h2>
                        <p id="meal-today-date" class="text-sm text-gray-500 mb-4"></p>
                        
                        <div id="meal-list" class="space-y-3">
                            <!-- Meal items will be injected here -->
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-gray-600">‡∏£‡∏ß‡∏°‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                                <p id="total-calories-display" class="font-bold text-pink-500">0 / 1,500 Kcal</p>
                            </div>
                        </div>
                    </div>
                     <div class="card mt-6">
                        <h2 class="text-lg font-bold text-gray-700 mb-2">üíß Water Tracker</h2>
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-sm text-gray-500">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 2.0 ‡∏•‡∏¥‡∏ï‡∏£</p>
                            <p id="water-intake-display" class="font-semibold text-blue-500">0.0 / 2.0 ‡∏•‡∏¥‡∏ï‡∏£</p>
                        </div>
                        <div id="water-drops-container" class="flex flex-wrap justify-center mb-4">
                           <!-- Water drops will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Period Tracker Tab -->
                <div id="period-tracker-tab" class="tab-content hidden">
                    <div class="card">
                        <h2 class="text-lg font-bold text-gray-700 mb-4">üåô Luna Diary</h2>
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-period" class="p-2 rounded-full hover:bg-pink-100"><i data-lucide="chevron-left" class="text-pink-500"></i></button>
                            <h3 id="current-month-period" class="text-lg font-semibold text-pink-500"></h3>
                            <button id="next-month-period" class="p-2 rounded-full hover:bg-pink-100"><i data-lucide="chevron-right" class="text-pink-500"></i></button>
                        </div>
                        <div class="grid grid-cols-7 text-center text-sm font-bold text-gray-400 mb-2">
                            <div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div>
                        </div>
                        <div id="period-calendar" class="calendar-grid"></div>
                        <div class="flex justify-center space-x-4 mt-4 text-xs">
                            <div class="flex items-center"><span class="w-3 h-3 bg-pink-500 rounded-full mr-2"></span>‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                            <div class="flex items-center"><span class="w-3 h-3 bg-pink-200 rounded-full mr-2"></span>‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
                        </div>
                        <div id="period-prediction-summary" class="text-center text-sm text-gray-600 mt-4 bg-pink-50 p-2 rounded-lg"></div>
                    </div>
                     <div class="card mt-6">
                        <button id="open-period-modal-btn" class="w-full btn-primary py-2">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</button>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div id="profile-tab" class="tab-content hidden">
                    <div class="card text-center">
                        <div id="profile-avatar-large" class="w-20 h-20 bg-pink-200 rounded-full flex items-center justify-center font-bold text-pink-600 text-3xl mx-auto mb-2">
                           <i data-lucide="user-round" class="w-12 h-12"></i>
                        </div>
                        <h2 id="profile-name-display" class="text-xl font-bold text-gray-800">--</h2>
                        <p id="profile-email-display" class="text-sm text-gray-500">--</p>
                    </div>
                    <div class="card mt-6">
                        <h3 class="font-bold text-gray-700 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                        <div id="profile-details-grid" class="grid grid-cols-2 gap-4 text-sm">
                           <!-- Profile details will be injected here -->
                        </div>
                         <button id="open-profile-modal-btn" class="w-full btn-primary py-2 mt-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                     <div class="mt-6">
                        <button id="logout-btn" class="w-full bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
            </main>

            <!-- Bottom Navigation -->
            <footer class="bg-white border-t border-gray-100 p-2">
                <nav class="flex justify-around">
                    <a href="#" data-tab="weight-tracker" class="nav-item flex-1 text-center p-2 tab-active">
                        <i data-lucide="scale" class="mx-auto"></i><span class="text-xs block">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</span>
                    </a>
                    <a href="#" data-tab="meal-planner" class="nav-item flex-1 text-center p-2 tab-inactive">
                        <i data-lucide="utensils-crossed" class="mx-auto"></i><span class="text-xs block">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                    </a>
                    <a href="#" data-tab="period-tracker" class="nav-item flex-1 text-center p-2 tab-inactive">
                        <i data-lucide="moon" class="mx-auto"></i><span class="text-xs block">‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                    </a>
                    <a href="#" data-tab="profile" class="nav-item flex-1 text-center p-2 tab-inactive">
                        <i data-lucide="user-circle" class="mx-auto"></i><span class="text-xs block">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
                    </a>
                </nav>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>


    <!-- Firebase -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            addDoc,
            collection,
            query,
            onSnapshot,
            orderBy,
            getDocs,
            where,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBTfOjuUjb9vVXCdE01pZP3mT1eEAgJMF8",
            authDomain: "rosietrack-e822c.firebaseapp.com",
            projectId: "rosietrack-e822c",
            storageBucket: "rosietrack-e822c.appspot.com",
            messagingSenderId: "1085754683487",
            appId: "1:1085754683487:web:d2f0b9f8f4a3c1e2b3a4d5" 
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;

        let currentUser = null;
        let userId = null;
        let weightChart = null;
        let profileUnsubscribe = null;
        let weightUnsubscribe = null;
        let mealUnsubscribe = null;
        let periodUnsubscribe = null;

        // --- UI ELEMENTS ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const modalContainer = document.getElementById('modal-container');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');

        // --- HELPER FUNCTIONS ---
        function showAuthError(message) {
            authError.textContent = message;
        }

        function toggleButtonLoading(button, isLoading) {
            const btnText = button.querySelector('.btn-text');
            const btnLoader = button.querySelector('.btn-loader');
            button.disabled = isLoading;
            if (isLoading && btnText && btnLoader) {
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');
            } else if (btnText && btnLoader) {
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }

        function toThaiDate(date) {
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
            });
        }

        // --- AUTH LOGIC ---
        function switchAuthTab(tab) {
            showAuthError('');
            if (tab === 'login') {
                loginTab.classList.add('tab-active');
                loginTab.classList.remove('tab-inactive');
                registerTab.classList.add('tab-inactive');
                registerTab.classList.remove('tab-active');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('tab-active');
                registerTab.classList.remove('tab-inactive');
                loginTab.classList.add('tab-inactive');
                loginTab.classList.remove('tab-active');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }
        
        loginTab.addEventListener('click', () => switchAuthTab('login'));
        registerTab.addEventListener('click', () => switchAuthTab('register'));

        document.getElementById('register-btn').addEventListener('click', async (e) => {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const button = e.currentTarget;
            
            if (!name || !email || !password) {
                showAuthError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á');
                return;
            }

            showAuthError('');
            toggleButtonLoading(button, true);

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const profileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'info');
                await setDoc(profileRef, { name: name, email: email });
            } catch (error) {
                handleAuthError(error);
            } finally {
                toggleButtonLoading(button, false);
            }
        });
        
        document.getElementById('login-btn').addEventListener('click', async (e) => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const button = e.currentTarget;

            if (!email || !password) {
                showAuthError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                return;
            }

            showAuthError('');
            toggleButtonLoading(button, true);

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                handleAuthError(error);
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        function handleAuthError(error) {
            console.error("Firebase Auth Error:", error.code, error.message);
            switch (error.code) {
                case 'auth/operation-not-allowed':
                    showAuthError('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Email/Password ‡πÉ‡∏ô Firebase Console');
                    break;
                case 'auth/email-already-in-use':
                    showAuthError('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                    break;
                case 'auth/weak-password':
                    showAuthError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                    break;
                case 'auth/invalid-email':
                    showAuthError('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    showAuthError('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    break;
                default:
                    showAuthError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
            }
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (profileUnsubscribe) profileUnsubscribe();
            if (weightUnsubscribe) weightUnsubscribe();
            if (mealUnsubscribe) mealUnsubscribe();
            if (periodUnsubscribe) periodUnsubscribe();

            if (user) {
                currentUser = user;
                userId = user.uid;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                initializeAppContent();
            } else {
                currentUser = null;
                userId = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                if (weightChart) {
                    weightChart.destroy();
                    weightChart = null;
                }
                switchAuthTab('login');
            }
        });

        // --- APP INITIALIZATION ---
        function initializeAppContent() {
            lucide.createIcons();
            setupNavigation();
            setupAllTabs();
            switchTab('weight-tracker');
        }

        // --- NAVIGATION & TABS ---
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = item.dataset.tab;
                    switchTab(tabId);
                });
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                const isTarget = item.dataset.tab === tabId;
                item.classList.toggle('tab-active', isTarget);
                item.classList.toggle('tab-inactive', !isTarget);
            });
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.toggle('hidden', tab.id !== `${tabId}-tab`);
            });
        }
        
        function setupAllTabs() {
            setupProfile();
            setupWeightTracker();
            setupMealPlanner();
            setupPeriodTracker();
        }

        // --- PROFILE ---
        function setupProfile() {
            const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'info');
            profileUnsubscribe = onSnapshot(profileRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                renderProfile(data);
                renderWeightProgress(data.startWeight, data.goalWeight, null); 
            });
            document.getElementById('open-profile-modal-btn').onclick = async () => {
                const docSnap = await getDoc(profileRef);
                showProfileModal(docSnap.exists() ? docSnap.data() : {});
            };
        }

        function renderProfile(data) {
            const name = data.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            const initial = name.charAt(0).toUpperCase();
            document.getElementById('profile-avatar').innerHTML = `<span class="text-xl">${initial}</span>`;
            document.getElementById('profile-avatar-large').innerHTML = `<span class="text-3xl">${initial}</span>`;
            document.getElementById('profile-name-display').textContent = name;
            document.getElementById('profile-email-display').textContent = currentUser.email;

            const detailsGrid = document.getElementById('profile-details-grid');
            detailsGrid.innerHTML = `
                <div><p class="text-gray-500">‡∏≠‡∏≤‡∏¢‡∏∏</p><p class="font-bold">${data.age || '--'} ‡∏õ‡∏µ</p></div>
                <div><p class="text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</p><p class="font-bold">${data.height || '--'} ‡∏ã‡∏°.</p></div>
                <div><p class="text-gray-500">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p><p class="font-bold">${data.startWeight || '--'} ‡∏Å‡∏Å.</p></div>
                <div><p class="text-gray-500">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p><p class="font-bold">${data.goalWeight || '--'} ‡∏Å‡∏Å.</p></div>
            `;
        }

        // --- WEIGHT TRACKER ---
        function setupWeightTracker() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const q = query(
                collection(db, `artifacts/${appId}/users/${userId}/weightEntries`), 
                where("date", ">=", Timestamp.fromDate(thirtyDaysAgo)),
                orderBy("date", "asc")
            );
            
            weightUnsubscribe = onSnapshot(q, async (snapshot) => {
                const entries = snapshot.docs.map(doc => doc.data());
                const latestWeight = entries.length > 0 ? entries[entries.length - 1].weight : null;
                
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'info');
                const profileSnap = await getDoc(profileRef);
                const profileData = profileSnap.exists() ? profileSnap.data() : {};

                renderWeightProgress(profileData.startWeight, profileData.goalWeight, latestWeight);
                renderWeightChart(entries);
            });
            document.getElementById('open-weight-modal-btn').onclick = () => showWeightModal();
        }

        function renderWeightProgress(start, goal, current) {
            document.getElementById('current-weight-display').textContent = current ? `${current.toFixed(1)} kg` : '-- kg';
            document.getElementById('goal-weight-display').textContent = goal ? `${goal.toFixed(1)} kg` : '-- kg';

            if (current && goal) {
                const diff = current - goal;
                document.getElementById('weight-diff-display').textContent = `${diff.toFixed(1)} kg`;
            } else {
                document.getElementById('weight-diff-display').textContent = '-- kg';
            }

            if (start && goal && current) {
                const totalRange = start - goal;
                const progressMade = start - current;
                let percentage = 0;
                if (totalRange > 0) {
                    percentage = Math.max(0, Math.min(100, (progressMade / totalRange) * 100));
                }
                document.getElementById('progress-percent-display').textContent = `${percentage.toFixed(0)}%`;
                document.getElementById('progress-fill-bar').style.width = `${percentage}%`;
            } else {
                document.getElementById('progress-percent-display').textContent = `0%`;
                document.getElementById('progress-fill-bar').style.width = `0%`;
            }
        }

        function renderWeightChart(entries) {
            const ctx = document.getElementById('weight-chart').getContext('2d');
            const labels = entries.map(e => e.date.toDate());
            const data = entries.map(e => e.weight);

            if (weightChart) weightChart.destroy();
            
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)',
                        data: data,
                        borderColor: '#ff8fab',
                        backgroundColor: 'rgba(255, 143, 171, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ff8fab',
                        pointRadius: data.length < 15 ? 4 : 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', tooltipFormat: 'dd MMM yy' },
                            grid: { display: false }
                        },
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        // --- MEAL PLANNER ---
        function setupMealPlanner() {
            const today = new Date();
            document.getElementById('meal-today-date').textContent = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${toThaiDate(today)}`;

            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const endOfDay = new Date(today.setHours(23, 59, 59, 999));

            const q = query(
                collection(db, `artifacts/${appId}/users/${userId}/mealEntries`),
                where("date", ">=", Timestamp.fromDate(startOfDay)),
                where("date", "<=", Timestamp.fromDate(endOfDay))
            );

            mealUnsubscribe = onSnapshot(q, (snapshot) => {
                const meals = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    meals[data.type] = { id: doc.id, ...data };
                });
                renderMealList(meals);
            });
            
            const waterDocId = new Date().toISOString().split('T')[0];
            const waterDocRef = doc(db, `artifacts/${appId}/users/${userId}/waterEntries`, waterDocId);
            onSnapshot(waterDocRef, (docSnap) => {
                const waterData = docSnap.exists() ? docSnap.data() : { intake: 0 };
                renderWaterTracker(waterData.intake);
            });
        }

        function renderMealList(meals) {
            const mealListEl = document.getElementById('meal-list');
            const mealTypes = [
                { key: 'breakfast', name: 'üåû ‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤' },
                { key: 'lunch', name: '‚òÄÔ∏è ‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô' },
                { key: 'dinner', name: 'üåô ‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô' },
                { key: 'snacks', name: 'üç™ ‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á' }
            ];
            let totalCalories = 0;
            mealListEl.innerHTML = '';

            mealTypes.forEach(type => {
                const meal = meals[type.key];
                let mealHTML;
                if (meal) {
                    totalCalories += meal.calories;
                    mealHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${meal.name}</p>
                                <p class="text-sm text-gray-500">${meal.calories} ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</p>
                            </div>
                            <button class="text-xs text-blue-500" data-meal-type="${type.key}" data-meal-data='${JSON.stringify(meal)}'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </div>
                    `;
                } else {
                    mealHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-500">${type.name}</p>
                            <button class="btn-primary text-xs px-2 py-1" data-meal-type="${type.key}">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        </div>
                    `;
                }
                mealListEl.innerHTML += `<div class="border-b border-gray-100 pb-3">${mealHTML}</div>`;
            });
            
            document.getElementById('total-calories-display').textContent = `${totalCalories.toLocaleString()} / 1,500 Kcal`;
            
            mealListEl.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => {
                    const mealData = btn.dataset.mealData ? JSON.parse(btn.dataset.mealData) : null;
                    showMealModal(btn.dataset.mealType, mealData);
                };
            });
        }
        
        function renderWaterTracker(intake = 0) {
            const container = document.getElementById('water-drops-container');
            container.innerHTML = '';
            const totalDrops = 10; // 200ml per drop for 2L goal
            const filledDrops = Math.round(intake / 0.2);
            
            document.getElementById('water-intake-display').textContent = `${intake.toFixed(1)} / 2.0 ‡∏•‡∏¥‡∏ï‡∏£`;

            for(let i = 1; i <= totalDrops; i++) {
                const drop = document.createElement('div');
                drop.className = `water-drop ${i <= filledDrops ? 'filled' : ''}`;
                drop.dataset.amount = (i * 0.2).toFixed(1);
                drop.onclick = async () => {
                    const newIntake = parseFloat(drop.dataset.amount);
                    const waterDocId = new Date().toISOString().split('T')[0];
                    const waterDocRef = doc(db, `artifacts/${appId}/users/${userId}/waterEntries`, waterDocId);
                    await setDoc(waterDocRef, { intake: newIntake, date: Timestamp.now() });
                };
                container.appendChild(drop);
            }
        }

        // --- PERIOD TRACKER ---
        let periodDate = new Date();
        function setupPeriodTracker() {
             document.getElementById('prev-month-period').addEventListener('click', () => {
                periodDate.setMonth(periodDate.getMonth() - 1);
                renderPeriodCalendar();
            });
            document.getElementById('next-month-period').addEventListener('click', () => {
                periodDate.setMonth(periodDate.getMonth() + 1);
                renderPeriodCalendar();
            });
            document.getElementById('open-period-modal-btn').onclick = () => showPeriodModal();

            periodUnsubscribe = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/periodEntries`), (snapshot) => {
                renderPeriodCalendar();
            });
        }
        
        async function renderPeriodCalendar() {
            const calendarEl = document.getElementById('period-calendar');
            const summaryEl = document.getElementById('period-prediction-summary');
            const monthTitleEl = document.getElementById('current-month-period');
            calendarEl.innerHTML = '';
            monthTitleEl.textContent = periodDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/periodEntries`), orderBy("startDate", "asc"));
            const snapshot = await getDocs(q);
            const periodEntries = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    startDate: data.startDate.toDate(),
                    endDate: data.endDate.toDate()
                }
            });

            let predictedStartDate = null;
            let predictedEndDate = null;

            if (periodEntries.length > 0) {
                let avgCycleLength = 28; // Default cycle length
                let avgPeriodDuration = 5; // Default period duration
                const oneDay = 1000 * 60 * 60 * 24;

                if (periodEntries.length > 1) {
                    let cycleSum = 0;
                    for (let i = 1; i < periodEntries.length; i++) {
                        const diffTime = Math.abs(periodEntries[i].startDate - periodEntries[i-1].startDate);
                        cycleSum += Math.round(diffTime / oneDay);
                    }
                    avgCycleLength = Math.round(cycleSum / (periodEntries.length - 1));
                }

                let durationSum = 0;
                periodEntries.forEach(entry => {
                    const diffTime = Math.abs(entry.endDate - entry.startDate);
                    durationSum += Math.round(diffTime / oneDay) + 1;
                });
                avgPeriodDuration = Math.round(durationSum / periodEntries.length);
                
                const lastEntry = periodEntries[periodEntries.length - 1];
                predictedStartDate = new Date(lastEntry.startDate);
                predictedStartDate.setDate(predictedStartDate.getDate() + avgCycleLength);

                predictedEndDate = new Date(predictedStartDate);
                predictedEndDate.setDate(predictedEndDate.getDate() + avgPeriodDuration - 1);

                summaryEl.innerHTML = `‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: <strong class="text-pink-600">${toThaiDate(predictedStartDate)}</strong> (‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgCycleLength} ‡∏ß‡∏±‡∏ô)`;
            } else {
                summaryEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå';
            }


            const year = periodDate.getFullYear();
            const month = periodDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarEl.insertAdjacentHTML('beforeend', '<div></div>');
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(year, month, day);
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;

                let isPeriod = false;
                for (const entry of periodEntries) {
                    if (currentDay >= entry.startDate && currentDay <= entry.endDate) {
                        isPeriod = true;
                        break;
                    }
                }
                
                if (isPeriod) {
                    dayEl.classList.add('period');
                } else if (predictedStartDate && currentDay >= predictedStartDate && currentDay <= predictedEndDate) {
                    dayEl.classList.add('predicted');
                }
                
                if(currentDay.toDateString() === today.toDateString()) {
                    dayEl.classList.add('today');
                }
                
                calendarEl.appendChild(dayEl);
            }
        }

        // --- MODALS ---
        function closeModal() {
            modalContainer.innerHTML = '';
        }
        
        function showWeightModal() {
            modalContainer.innerHTML = `
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="card p-6 w-full max-w-sm">
                        <h3 class="font-bold text-lg mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input id="modal-weight-date" type="date" class="input-field">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</label>
                            <input id="modal-weight-input" type="number" step="0.1" class="input-field" placeholder="55.5">
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button id="modal-cancel" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button id="modal-save-weight" class="btn-primary px-6">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-weight-date').valueAsDate = new Date();

            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save-weight').onclick = async () => {
                const weight = parseFloat(document.getElementById('modal-weight-input').value);
                const selectedDate = document.getElementById('modal-weight-date').value;

                if (!weight || weight <= 0 || !selectedDate) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                    return;
                }
                
                try {
                    const date = new Date(selectedDate + 'T00:00:00');
                    const docId = date.toISOString().split('T')[0];
                    const weightRef = doc(db, `artifacts/${appId}/users/${userId}/weightEntries`, docId);
                    await setDoc(weightRef, {
                        weight: weight,
                        date: Timestamp.fromDate(date)
                    });
                    
                    const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'info');
                    const profileSnap = await getDoc(profileRef);
                    if (!profileSnap.exists() || !profileSnap.data().startWeight) {
                        await setDoc(profileRef, { startWeight: weight }, { merge: true });
                    }
                    closeModal();
                } catch (error) {
                    console.error("Error saving weight:", error);
                }
            };
        }
        
        function showMealModal(type, data) {
             modalContainer.innerHTML = `
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="card p-6 w-full max-w-sm">
                        <h3 class="font-bold text-lg mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å${data ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : ''}‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                            <input id="modal-meal-name" type="text" class="input-field" value="${data?.name || ''}">
                        </div>
                         <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</label>
                            <input id="modal-meal-calories" type="number" class="input-field" value="${data?.calories || ''}">
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button id="modal-cancel" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button id="modal-save-meal" class="btn-primary px-6">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save-meal').onclick = async () => {
                const name = document.getElementById('modal-meal-name').value;
                const calories = parseInt(document.getElementById('modal-meal-calories').value);
                if (!name || isNaN(calories)) return;
                
                const mealDocId = data?.id || `${new Date().toISOString().split('T')[0]}_${type}`;
                const mealRef = doc(db, `artifacts/${appId}/users/${userId}/mealEntries`, mealDocId);

                await setDoc(mealRef, {
                    name,
                    calories,
                    type,
                    date: data ? data.date : Timestamp.now()
                });
                closeModal();
            };
        }
        
        function showPeriodModal() {
            modalContainer.innerHTML = `
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="card p-6 w-full max-w-sm">
                        <h3 class="font-bold text-lg mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                            <input id="modal-period-start" type="date" class="input-field">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                            <input id="modal-period-end" type="date" class="input-field">
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button id="modal-cancel" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button id="modal-save-period" class="btn-primary px-6">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save-period').onclick = async () => {
                const startDate = document.getElementById('modal-period-start').value;
                const endDate = document.getElementById('modal-period-end').value;
                if (!startDate || !endDate) return;

                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/periodEntries`), {
                    startDate: Timestamp.fromDate(new Date(startDate)),
                    endDate: Timestamp.fromDate(new Date(endDate))
                });
                closeModal();
            };
        }

        function showProfileModal(data) {
            modalContainer.innerHTML = `
                <div class="modal-backdrop fixed inset-0 flex items-center justify-center p-4">
                    <div class="card p-6 w-full max-w-sm">
                        <h3 class="font-bold text-lg mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                        <div class="space-y-4">
                            <div><label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠</label><input id="modal-profile-name" type="text" class="input-field" value="${data.name || ''}"></div>
                            <div><label class="text-sm">‡∏≠‡∏≤‡∏¢‡∏∏</label><input id="modal-profile-age" type="number" class="input-field" value="${data.age || ''}"></div>
                            <div><label class="text-sm">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input id="modal-profile-height" type="number" class="input-field" value="${data.height || ''}"></div>
                            <div><label class="text-sm">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏Å‡∏Å.)</label><input id="modal-profile-goal" type="number" step="0.1" class="input-field" value="${data.goalWeight || ''}"></div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-6">
                            <button id="modal-cancel" class="btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button id="modal-save-profile" class="btn-primary px-6">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save-profile').onclick = async () => {
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'info');
                const profileData = {
                    name: document.getElementById('modal-profile-name').value || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                    age: parseInt(document.getElementById('modal-profile-age').value) || null,
                    height: parseInt(document.getElementById('modal-profile-height').value) || null,
                    goalWeight: parseFloat(document.getElementById('modal-profile-goal').value) || null
                };
                await setDoc(profileRef, profileData, { merge: true });
                closeModal();
            };
        }

    </script>
</body>
</html>