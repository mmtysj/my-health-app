import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, deleteDoc, doc, setDoc, getDoc } from 'firebase/firestore';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { TrendingUp, TrendingDown, Minus, Scale, Calendar, Trash2, BarChart3, MessageSquareQuote, Weight, UtensilsCrossed, ChevronLeft, ChevronRight, GlassWater, BookText, LogOut, UserCircle } from 'lucide-react';

// ++ FIREBASE CONFIGURATION ++
const firebaseConfig = {
  apiKey: "AIzaSyD5wqSQceZ_xaqFRHkTUvMHiGYmu-xZStw",
  authDomain: "my-health-tracker-app-4420e.firebaseapp.com",
  projectId: "my-health-tracker-app-4420e",
  storageBucket: "my-health-tracker-app-4420e.appspot.com",
  messagingSenderId: "191048717930",
  appId: "1:191048717930:web:bb98c8cc9e8f64dbe8dc13",
  measurementId: "G-Z3XGL5CCGY"
};// -- FIREBASE CONFIGURATION --

// Helper function to format date for display
const formatDate = (dateString) => {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(dateString + 'T00:00:00').toLocaleDateString('th-TH', options);
};

// A cute flower icon for decoration
const FlowerIcon = () => (
    <svg className="w-8 h-8 text-pink-300 inline-block" stroke="currentColor" fill="currentColor" strokeWidth="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M464 256c0-114.9-93.1-208-208-208S48 141.1 48 256s93.1 208 208 208 208-93.1 208-208zm-208-96c-53 0-96 43-96 96s43 96 96 96 96-43 96-96-43-96-96-96zM256 512c141.4 0 256-114.6 256-256S397.4 0 256 0 0 114.6 0 256s114.6 256 256 256z" opacity=".3"></path>
        <path d="M256 128c-70.7 0-128 57.3-128 128s57.3 128 128 128 128-57.3 128-128-57.3-128-128-128zm0 224c-53 0-96-43-96-96s43-96 96-96 96 43 96 96-43 96-96 96z"></path>
    </svg>
);


// Main App Component
function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [error, setError] = useState(null);
    const [activeTab, setActiveTab] = useState('tracker');
    const [nickname, setNickname] = useState(null);
    const [isAppLoading, setIsAppLoading] = useState(true);

    // Check for nickname in localStorage on initial load
    useEffect(() => {
        const savedNickname = localStorage.getItem('healthTrackerNickname');
        if (savedNickname) {
            setNickname(savedNickname);
        }
        setIsAppLoading(false);
    }, []);

    // Initialize Firebase and set up authentication
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);
            setDb(firestore);
            setAuth(authInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    try {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(authInstance, __initial_auth_token);
                         } else {
                            await signInAnonymously(authInstance);
                         }
                    } catch (authError) {
                        console.error("Authentication Error:", authError);
                        setError("เกิดข้อผิดพลาดในการยืนยันตัวตน");
                    }
                }
                setIsAuthReady(true);
            });
            return () => unsubscribe();
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            setError("ไม่สามารถเริ่มต้นการเชื่อมต่อกับฐานข้อมูลได้");
        }
    }, []);

    const handleLogin = (name) => {
        localStorage.setItem('healthTrackerNickname', name);
        setNickname(name);
    };

    const handleLogout = () => {
        localStorage.removeItem('healthTrackerNickname');
        setNickname(null);
    };

    if (isAppLoading || !isAuthReady) {
        return (
            <div className="bg-pink-50 min-h-screen flex justify-center items-center">
                <p className="text-pink-500">กำลังเตรียมแอปสักครู่...</p>
            </div>
        );
    }
    
    if (!nickname) {
        return <LoginScreen onLogin={handleLogin} />;
    }

    return (
        <div className="bg-pink-50 min-h-screen font-sans text-pink-800 p-4 sm:p-6 lg:p-8">
            <div className="max-w-6xl mx-auto">
                <Header userId={userId} nickname={nickname} onLogout={handleLogout} />
                {error && <ErrorMessage message={error} />}
                
                <TabNavigation activeTab={activeTab} setActiveTab={setActiveTab} />

                <main className="mt-6">
                    {activeTab === 'tracker' && <WeightTrackerTab db={db} userId={userId} isAuthReady={isAuthReady} setError={setError} />}
                    {activeTab === 'planner' && <MealPlannerTab db={db} userId={userId} isAuthReady={isAuthReady} setError={setError} />}
                </main>
            </div>
        </div>
    );
}

// Login Screen Component
const LoginScreen = ({ onLogin }) => {
    const [name, setName] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (name.trim()) {
            onLogin(name.trim());
        }
    };

    return (
        <div className="bg-pink-50 min-h-screen flex flex-col justify-center items-center p-4">
            <div className="w-full max-w-sm text-center">
                <h1 className="text-4xl font-bold text-pink-800 mb-2 flex justify-center items-center gap-2">
                    <FlowerIcon /> Health Tracker <FlowerIcon />
                </h1>
                <p className="text-pink-500 mb-8">ยินดีต้อนรับ! กรุณาบอกชื่อเล่นของคุณ</p>
                <div className="bg-white p-8 rounded-2xl shadow-lg shadow-pink-100">
                    <form onSubmit={handleSubmit}>
                        <label htmlFor="nickname" className="block text-lg font-semibold text-pink-700 mb-4">
                            ใส่ชื่อเล่นของคุณที่นี่
                        </label>
                        <input
                            id="nickname"
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="เช่น น้องชมพู"
                            className="w-full p-3 border border-pink-200 rounded-lg bg-white text-center text-lg focus:ring-2 focus:ring-pink-400 focus:border-pink-400"
                            required
                        />
                        <button type="submit" className="w-full mt-6 bg-pink-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-pink-600 transition-colors duration-300 shadow-md hover:shadow-lg">
                            เข้าสู่ระบบ
                        </button>
                    </form>
                </div>
            </div>
        </div>
    );
};


// Tab Navigation Component
const TabNavigation = ({ activeTab, setActiveTab }) => (
    <div className="flex justify-center border-b border-pink-200 mb-6">
        <button
            onClick={() => setActiveTab('tracker')}
            className={`flex items-center gap-2 px-4 py-3 font-semibold transition-colors ${activeTab === 'tracker' ? 'border-b-2 border-pink-500 text-pink-600' : 'text-pink-400 hover:text-pink-600'}`}
        >
            <Weight className="w-5 h-5" />
            บันทึกน้ำหนัก
        </button>
        <button
            onClick={() => setActiveTab('planner')}
            className={`flex items-center gap-2 px-4 py-3 font-semibold transition-colors ${activeTab === 'planner' ? 'border-b-2 border-pink-500 text-pink-600' : 'text-pink-400 hover:text-pink-600'}`}
        >
            <UtensilsCrossed className="w-5 h-5" />
            วางแผนมื้ออาหาร
        </button>
    </div>
);

// Weight Tracker Tab Component
const WeightTrackerTab = ({ db, userId, isAuthReady, setError }) => {
    const [weights, setWeights] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        if (isAuthReady && db && userId) {
            setIsLoading(true);
            const weightsCollectionPath = `artifacts/${appId}/users/${userId}/weights`;
            const q = query(collection(db, weightsCollectionPath), orderBy('timestamp', 'desc'));

            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const weightsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setWeights(weightsData);
                setIsLoading(false);
            }, (err) => {
                console.error("Firestore Error:", err);
                setError("ไม่สามารถดึงข้อมูลน้ำหนักได้");
                setIsLoading(false);
            });
            return () => unsubscribe();
        } else if (isAuthReady) {
            setIsLoading(false);
        }
    }, [isAuthReady, db, userId, setError]);

    const addWeight = useCallback(async (weight, date) => {
        if (!db || !userId) return;
        if (!weight || !date || isNaN(parseFloat(weight))) {
            alert("กรุณากรอกข้อมูลน้ำหนักและวันที่ให้ถูกต้อง");
            return;
        }
        try {
            const weightsCollectionPath = `artifacts/${appId}/users/${userId}/weights`;
            await addDoc(collection(db, weightsCollectionPath), {
                weight: parseFloat(weight),
                date: date,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Error adding document: ", e);
            setError("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
        }
    }, [db, userId, setError]);

    const deleteWeight = useCallback(async (id) => {
        if (window.confirm("คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลนี้?")) {
            if (!db || !userId) return;
            try {
                const docPath = `artifacts/${appId}/users/${userId}/weights/${id}`;
                await deleteDoc(doc(db, docPath));
            } catch (e) {
                console.error("Error deleting document: ", e);
                setError("เกิดข้อผิดพลาดในการลบข้อมูล");
            }
        }
    }, [db, userId, setError]);

    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-3">
                 <WeightInput addWeight={addWeight} />
            </div>
            {isLoading ? (
                <div className="lg:col-span-3 text-center p-10"><p>กำลังโหลดข้อมูล...</p></div>
            ) : weights.length > 0 ? (
                <>
                    <div className="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <WeeklyTrend weights={weights} />
                        <MonthlyReport weights={weights} />
                    </div>
                    <div className="lg:col-span-3">
                        <HistoryList weights={weights} deleteWeight={deleteWeight} />
                    </div>
                </>
            ) : (
                <div className="lg:col-span-3 bg-white p-8 rounded-2xl shadow-lg shadow-pink-100 text-center">
                    <h3 className="text-xl font-semibold mb-2 text-pink-700">ยังไม่มีข้อมูลน้ำหนัก</h3>
                    <p className="text-pink-500">เริ่มต้นบันทึกน้ำหนักของคุณโดยใช้แบบฟอร์มด้านบนได้เลย!</p>
                </div>
            )}
        </div>
    );
};

// Meal Planner Tab Component
const MealPlannerTab = ({ db, userId, isAuthReady, setError }) => {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [mealData, setMealData] = useState({ days: {}, notes: '' });
    const [isLoading, setIsLoading] = useState(true);

    const monthId = useMemo(() => currentDate.toISOString().slice(0, 7), [currentDate]);

    useEffect(() => {
        if (isAuthReady && db && userId) {
            setIsLoading(true);
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mealPlans`, monthId);
            getDoc(docRef).then(docSnap => {
                if (docSnap.exists()) {
                    setMealData(docSnap.data());
                } else {
                    setMealData({ days: {}, notes: '' });
                }
                setIsLoading(false);
            }).catch(err => {
                console.error("Error fetching meal plan:", err);
                setError("ไม่สามารถดึงข้อมูลแผนมื้ออาหารได้");
                setIsLoading(false);
            });
        }
    }, [isAuthReady, db, userId, monthId, setError]);

    const saveMealData = useCallback(async (data) => {
        if (!isAuthReady || !db || !userId) return;
        try {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/mealPlans`, monthId);
            await setDoc(docRef, data, { merge: true });
        } catch (err) {
            console.error("Error saving meal plan:", err);
            setError("เกิดข้อผิดพลาดในการบันทึกแผนมื้ออาหาร");
        }
    }, [isAuthReady, db, userId, monthId, setError]);

    const handleMealInputChange = (dateKey, field, value) => {
        const newData = { ...mealData, days: { ...mealData.days, [dateKey]: { ...mealData.days[dateKey], [field]: value } } };
        setMealData(newData);
        saveMealData(newData);
    };

    const handleNotesChange = (value) => {
        const newData = { ...mealData, notes: value };
        setMealData(newData);
        saveMealData(newData);
    };

    const changeMonth = (offset) => {
        setCurrentDate(prevDate => {
            const newDate = new Date(prevDate);
            newDate.setMonth(newDate.getMonth() + offset);
            return newDate;
        });
    };

    const calendarDays = useMemo(() => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const days = [];
        const startDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;
        for (let i = 0; i < startDay; i++) { days.push({ key: `empty-${i}`, empty: true }); }
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            days.push({ key: `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`, date, dayNumber: day, dayOfWeek: date.getDay() });
        }
        return days;
    }, [currentDate]);

    return (
        <div className="bg-white p-6 rounded-2xl shadow-lg shadow-pink-100">
            <div className="flex items-center justify-between mb-4">
                <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-pink-100"><ChevronLeft className="text-pink-500"/></button>
                <h2 className="text-2xl font-bold text-pink-700">
                    {currentDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}
                </h2>
                <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-pink-100"><ChevronRight className="text-pink-500"/></button>
            </div>

            {isLoading ? <div className="text-center p-10"><p>กำลังโหลดแผนมื้ออาหาร...</p></div> :
            <>
                <div className="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-pink-500 mb-2">
                    <div>จันทร์</div><div>อังคาร</div><div>พุธ</div><div>พฤหัสบดี</div><div>ศุกร์</div><div className="text-gray-400">เสาร์</div><div className="text-gray-400">อาทิตย์</div>
                </div>
                <div className="grid grid-cols-7 gap-2">
                    {calendarDays.map(day => (
                        day.empty ? <div key={day.key} className="border-transparent rounded-lg"></div> :
                        <div key={day.key} className={`p-2 border border-pink-100 rounded-lg ${day.dayOfWeek === 0 || day.dayOfWeek === 6 ? 'bg-pink-50/50' : 'bg-white'} min-h-[150px]`}>
                            <span className={`font-bold ${day.dayOfWeek === 0 || day.dayOfWeek === 6 ? 'text-gray-400' : 'text-pink-600'}`}>{day.dayNumber}</span>
                            {(day.dayOfWeek !== 0 && day.dayOfWeek !== 6) && (
                                <div className="mt-1 space-y-1">
                                    <MealInput placeholder="เช้า" value={mealData.days?.[day.key]?.breakfast || ''} onChange={e => handleMealInputChange(day.key, 'breakfast', e.target.value)} />
                                    <MealInput placeholder="กลางวัน" value={mealData.days?.[day.key]?.lunch || ''} onChange={e => handleMealInputChange(day.key, 'lunch', e.target.value)} />
                                    <MealInput placeholder="เย็น" value={mealData.days?.[day.key]?.dinner || ''} onChange={e => handleMealInputChange(day.key, 'dinner', e.target.value)} />
                                    <MealInput placeholder="ของว่าง" value={mealData.days?.[day.key]?.snacks || ''} onChange={e => handleMealInputChange(day.key, 'snacks', e.target.value)} />
                                    <div className="flex items-center gap-1">
                                        <GlassWater className="w-4 h-4 text-sky-400" />
                                        <MealInput type="number" placeholder="น้ำ (ลิตร)" value={mealData.days?.[day.key]?.water || ''} onChange={e => handleMealInputChange(day.key, 'water', e.target.value)} />
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
                <div className="mt-6">
                    <h3 className="text-lg font-semibold mb-2 flex items-center gap-2"><BookText className="w-5 h-5 text-pink-500" />บันทึกเพิ่มเติม</h3>
                    <textarea 
                        value={mealData.notes || ''}
                        onChange={e => handleNotesChange(e.target.value)}
                        placeholder="จดบันทึกเกี่ยวกับแผนอาหารของเดือนนี้..."
                        className="w-full p-3 border border-pink-200 rounded-lg bg-white focus:ring-2 focus:ring-pink-400 focus:border-pink-400 h-24"
                    />
                </div>
            </>
            }
        </div>
    );
};

const MealInput = ({ placeholder, type = 'text', value, onChange }) => (
    <input type={type} placeholder={placeholder} value={value} onChange={onChange} className="w-full text-xs p-1 border border-pink-200 rounded bg-transparent focus:ring-1 focus:ring-pink-400 focus:border-pink-400" />
);

const Header = ({ userId, nickname, onLogout }) => (
    <header className="mb-4 text-center pt-8 relative">
        <h1 className="text-4xl font-bold text-pink-800 mb-2 flex justify-center items-center gap-2">
            <FlowerIcon /> Health Tracker <FlowerIcon />
        </h1>
        <p className="text-pink-500">ติดตามสุขภาพและบรรลุเป้าหมายของคุณ</p>
        
        {nickname && (
            <div className="absolute top-0 right-0 mt-2 mr-2 flex flex-col items-end sm:flex-row sm:items-center gap-2 bg-white/50 backdrop-blur-sm p-2 rounded-lg">
                <div className="flex items-center gap-2">
                    <UserCircle className="w-5 h-5 text-pink-600" />
                    <span className="font-semibold text-pink-700">{nickname}</span>
                </div>
                <button onClick={onLogout} className="flex items-center gap-1 text-xs text-pink-500 hover:text-red-500 hover:underline">
                    <LogOut className="w-3 h-3"/>
                    <span>ออกจากระบบ</span>
                </button>
            </div>
        )}
        
        {userId && <p className="text-xs text-pink-300 mt-2">User ID: {userId}</p>}
    </header>
);

const ErrorMessage = ({ message }) => (
    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
        <strong className="font-bold">เกิดข้อผิดพลาด!</strong>
        <span className="block sm:inline ml-2">{message}</span>
    </div>
);

const WeightInput = ({ addWeight }) => {
    const [weight, setWeight] = useState('');
    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

    const handleSubmit = (e) => {
        e.preventDefault();
        addWeight(weight, date);
        setWeight('');
    };

    return (
        <div className="bg-white p-6 rounded-2xl shadow-lg shadow-pink-100">
            <h2 className="text-2xl font-semibold mb-4 text-pink-700">บันทึกน้ำหนัก</h2>
            <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row gap-4 items-end">
                <div className="flex-grow">
                    <label htmlFor="weight" className="block text-sm font-medium text-pink-600 mb-1">น้ำหนัก (กก.)</label>
                    <input id="weight" type="number" step="0.01" value={weight} onChange={(e) => setWeight(e.target.value)} placeholder="เช่น 59.50" className="w-full p-3 border border-pink-200 rounded-lg bg-white focus:ring-2 focus:ring-pink-400 focus:border-pink-400" required />
                </div>
                <div>
                    <label htmlFor="date" className="block text-sm font-medium text-pink-600 mb-1">วันที่</label>
                    <input id="date" type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-3 border border-pink-200 rounded-lg bg-white focus:ring-2 focus:ring-pink-400 focus:border-pink-400" required />
                </div>
                <div className="w-full sm:w-auto">
                    <button type="submit" className="w-full bg-pink-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-pink-600 transition-colors duration-300 shadow-md hover:shadow-lg">
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    );
};

const WeeklyTrend = ({ weights }) => {
    const weeklyData = useMemo(() => {
        if (weights.length < 2) return null;
        const sortedWeights = [...weights].sort((a, b) => new Date(a.date) - new Date(b.date));
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const last7DaysEntries = sortedWeights.filter(entry => new Date(entry.date) >= sevenDaysAgo);

        if (last7DaysEntries.length < 2) return null;

        const latestWeight = last7DaysEntries[last7DaysEntries.length - 1].weight;
        const oldestWeight = last7DaysEntries[0].weight;
        const change = latestWeight - oldestWeight;
        const average = last7DaysEntries.reduce((sum, entry) => sum + entry.weight, 0) / last7DaysEntries.length;
        const chartData = last7DaysEntries.map(d => ({ name: new Date(d.date).toLocaleDateString('th-TH', { month: 'short', day: 'numeric' }), 'น้ำหนัก': d.weight }));
        
        return { change, average, chartData };
    }, [weights]);

    if (!weeklyData) {
        return (
            <div className="bg-white p-6 rounded-2xl shadow-lg shadow-pink-100 flex flex-col justify-center items-center h-full min-h-[280px]">
                <BarChart3 className="w-12 h-12 text-pink-300 mb-4" />
                <h3 className="text-xl font-semibold mb-2 text-pink-700">สรุปรายสัปดาห์</h3>
                <p className="text-pink-400 text-center">ต้องการข้อมูลอย่างน้อย 2 วันใน 7 วันล่าสุดเพื่อแสดงแนวโน้ม</p>
            </div>
        );
    }
    
    const { change, average, chartData } = weeklyData;
    const TrendIcon = change > 0.1 ? TrendingUp : change < -0.1 ? TrendingDown : Minus;
    const trendColor = change > 0.1 ? 'text-red-500' : change < -0.1 ? 'text-green-500' : 'text-gray-500';

    return (
        <div className="bg-white p-6 rounded-2xl shadow-lg shadow-pink-100">
            <h3 className="text-xl font-semibold mb-4 flex items-center gap-2 text-pink-700"><BarChart3 className="w-6 h-6 text-pink-500"/>สรุปแนวโน้ม 7 วัน</h3>
            <div className="h-48 mb-4">
                <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={chartData}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#fce7f3" />
                        <XAxis dataKey="name" fontSize={12} stroke="#fda4af" />
                        <YAxis domain={['dataMin - 1', 'dataMax + 1']} fontSize={12} stroke="#fda4af" />
                        <Tooltip contentStyle={{ backgroundColor: 'rgba(255, 255, 255, 0.8)', border: '1px solid #fbcfe8', borderRadius: '1rem' }}/>
                        <Legend wrapperStyle={{color: '#db2777'}}/>
                        <Line type="monotone" dataKey="น้ำหนัก" stroke="#ec4899" strokeWidth={2} dot={{ r: 4, fill: '#ec4899' }} activeDot={{ r: 6, fill: '#be185d' }} />
                    </LineChart>
                </ResponsiveContainer>
            </div>
            <div className="flex justify-around text-center">
                <div>
                    <p className="text-sm text-pink-400">การเปลี่ยนแปลง</p>
                    <p className={`text-lg font-bold ${trendColor} flex items-center justify-center gap-1`}><TrendIcon className="w-5 h-5" />{change.toFixed(2)} กก.</p>
                </div>
                <div>
                    <p className="text-sm text-pink-400">ค่าเฉลี่ย</p>
                    <p className="text-lg font-bold text-pink-600 flex items-center justify-center gap-1"><Scale className="w-5 h-5" />{average.toFixed(2)} กก.</p>
                </div>
            </div>
        </div>
    );
};

const MonthlyReport = ({ weights }) => {
    const monthlyReport = useMemo(() => {
        if (weights.length < 2) return null;
        const sortedWeights = [...weights].sort((a, b) => new Date(a.date) - new Date(b.date));
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const last30DaysEntries = sortedWeights.filter(entry => new Date(entry.date) >= thirtyDaysAgo);

        if (last30DaysEntries.length < 2) return null;

        const latestEntry = last30DaysEntries[last30DaysEntries.length - 1];
        const oldestEntry = last30DaysEntries[0];
        const totalChange = latestEntry.weight - oldestEntry.weight;
        const consistency = last30DaysEntries.length;
        
        let advice = "", adviceType = "neutral";
        if (totalChange < -1.5) { advice = "ยอดเยี่ยมมาก! 👍 น้ำหนักของคุณลดลงอย่างเห็นได้ชัดในเดือนนี้ รักษาพฤติกรรมที่ดีนี้ต่อไป คุณมาถูกทางแล้ว!"; adviceType = "positive"; }
        else if (totalChange < -0.5) { advice = "ทำได้ดี! 📉 น้ำหนักของคุณมีแนวโน้มลดลงอย่างต่อเนื่อง พยายามต่อไปเพื่อไปให้ถึงเป้าหมายนะคะ"; adviceType = "positive"; }
        else if (totalChange > 1.5) { advice = "น้ำหนักของคุณมีแนวโน้มเพิ่มขึ้น 📈 ลองทบทวนการรับประทานอาหารและกิจกรรมในเดือนที่ผ่านมา อาจต้องปรับเปลี่ยนเล็กน้อย"; adviceType = "warning"; }
        else if (totalChange > 0.5) { advice = "น้ำหนักเพิ่มขึ้นเล็กน้อย ลองสังเกตพฤติกรรมดูนะคะ อาจมีบางวันที่เราตามใจตัวเองมากไปหน่อย"; adviceType = "warning"; }
        else { advice = "น้ำหนักของคุณค่อนข้างคงที่ ⚖️ ซึ่งเป็นสัญญาณที่ดีของการรักษาน้ำหนักตัว หากนี่คือเป้าหมายของคุณ ถือว่าทำได้ดีมากค่ะ!"; adviceType = "neutral"; }
        
        const weightsOnly = last30DaysEntries.map(e => e.weight);
        const stdDev = Math.sqrt(weightsOnly.map(x => Math.pow(x - (weightsOnly.reduce((a, b) => a + b) / weightsOnly.length), 2)).reduce((a, b) => a + b) / weightsOnly.length);
        if (stdDev > 0.8 && Math.abs(totalChange) < 1.0) { advice = "น้ำหนักของคุณค่อนข้างผันผวน 波动 ถึงแม้ภาพรวมจะคงที่ ลองชั่งน้ำหนักในเวลาเดียวกันทุกวันเพื่อข้อมูลที่แม่นยำขึ้นนะคะ"; adviceType = "neutral"; }

        return { totalChange, consistency, advice, adviceType };
    }, [weights]);

    if (!monthlyReport) {
        return (
            <div className="bg-white p-6 rounded-2xl shadow-lg shadow-pink-100 flex flex-col justify-center items-center h-full min-h-[280px]">
                <MessageSquareQuote className="w-12 h-12 text-pink-300 mb-4" />
                <h3 className="text-xl font-semibold mb-2 text-pink-700">รายงาน 30 วัน</h3>
                <p className="text-pink-400 text-center">ต้องการข้อมูลอย่างน้อย 2 วันใน 30 วันล่าสุดเพื่อสร้างรายงาน</p>
            </div>
        );
    }
    
    const { totalChange, consistency, advice, adviceType } = monthlyReport;
    const TrendIcon = totalChange > 0.1 ? TrendingUp : totalChange < -0.1 ? TrendingDown : Minus;
    const trendColor = totalChange > 0.1 ? 'text-red-500' : totalChange < -0.1 ? 'text-green-500' : 'text-gray-500';
    const adviceColor = {
        positive: "bg-teal-50 text-teal-700",
        warning: "bg-orange-50 text-orange-700",
        neutral: "bg-rose-50 text-rose-700",
    }[adviceType];

    return (
        <div className="bg-white p-6 rounded-2xl shadow-lg shadow-pink-100">
            <h3 className="text-xl font-semibold mb-4 flex items-center gap-2 text-pink-700"><MessageSquareQuote className="w-6 h-6 text-pink-500"/>รายงานและคำแนะนำ 30 วัน</h3>
            <div className="flex justify-around text-center mb-6">
                <div>
                    <p className="text-sm text-pink-400">การเปลี่ยนแปลงทั้งหมด</p>
                    <p className={`text-lg font-bold ${trendColor} flex items-center justify-center gap-1`}><TrendIcon className="w-5 h-5" />{totalChange.toFixed(2)} กก.</p>
                </div>
                <div>
                    <p className="text-sm text-pink-400">บันทึกข้อมูล</p>
                    <p className="text-lg font-bold text-pink-600 flex items-center justify-center gap-1"><Calendar className="w-5 h-5" />{consistency} วัน</p>
                </div>
            </div>
            <div className={`p-4 rounded-lg ${adviceColor}`}><p className="text-sm font-medium">{advice}</p></div>
        </div>
    );
};

const HistoryList = ({ weights, deleteWeight }) => (
    <div className="bg-white p-6 rounded-2xl shadow-lg shadow-pink-100">
        <h3 className="text-xl font-semibold mb-4 text-pink-700">ประวัติการบันทึก</h3>
        <div className="max-h-96 overflow-y-auto">
            <ul className="divide-y divide-pink-100">
                {weights.map((entry) => (
                    <li key={entry.id} className="flex items-center justify-between py-3 px-2 hover:bg-pink-50/50 rounded-md">
                        <div>
                            <p className="font-semibold text-pink-700">{entry.weight.toFixed(2)} กก.</p>
                            <p className="text-sm text-pink-400">{formatDate(entry.date)}</p>
                        </div>
                        <button onClick={() => deleteWeight(entry.id)} className="text-pink-300 hover:text-red-500 p-2 rounded-full transition-colors"><Trash2 className="w-5 h-5" /></button>
                    </li>
                ))}
            </ul>
        </div>
    </div>
);

export default App;